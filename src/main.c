#include <pspkernel.h>
#include <string.h>
#include <stdio.h>
#include <pspctrl.h>
#include <pspdisplay.h>

#include "sctrl.h"
#include "lib.h"

PSP_MODULE_INFO("ctwcheatdevice", PSP_MODULE_KERNEL, 1, 0);

#define VRAM 0x44000000

/*
 * DAT_0000151C
 * REV: Is cheat disabled / enabled?
 */
int cheat_state = 1;

/*
 * DAT_00001520
 * REV: Font used for drawing the menu on screen
 */
const char font[1508] =
{
	0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00,
	0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x22, 0x22, 0x22, 0x22, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x12, 0x12, 0x12, 0x7E, 0x24, 0x24, 0x7E, 0x48, 0x48, 0x48, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x08, 0x3E, 0x49, 0x48, 0x38, 0x0E, 0x09, 0x49,
	0x3E, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x4A, 0x4A, 0x34,
	0x08, 0x08, 0x16, 0x29, 0x29, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x1C, 0x22, 0x22, 0x22, 0x1C, 0x39, 0x45, 0x42, 0x46, 0x39, 0x00, 0x00,
	0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x08, 0x08, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x08, 0x08, 0x04, 0x00, 0x00, 0x00, 0x00, 0x20,
	0x10, 0x10, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x10, 0x20, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x49, 0x2A, 0x1C, 0x2A, 0x49,
	0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08,
	0x08, 0x7F, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x08, 0x08, 0x10,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x02, 0x02, 0x04, 0x08, 0x08, 0x10, 0x10, 0x20, 0x40, 0x40, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x18, 0x24, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
	0x24, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x18, 0x28, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3C, 0x42, 0x42, 0x02, 0x0C, 0x10, 0x20, 0x40, 0x40, 0x7E, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x02, 0x1C, 0x02, 0x02, 0x42,
	0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x0C, 0x14, 0x24,
	0x44, 0x44, 0x7E, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x7E, 0x40, 0x40, 0x40, 0x7C, 0x02, 0x02, 0x02, 0x42, 0x3C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x1C, 0x20, 0x40, 0x40, 0x7C, 0x42, 0x42, 0x42,
	0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x02, 0x02, 0x04,
	0x04, 0x04, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3C, 0x42, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3E, 0x02, 0x02, 0x02,
	0x04, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18,
	0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x08, 0x08, 0x10, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x10, 0x08,
	0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E,
	0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x02, 0x04, 0x08, 0x08, 0x00,
	0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x22, 0x4A, 0x56,
	0x52, 0x52, 0x52, 0x4E, 0x20, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x18, 0x24, 0x24, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x7C, 0x42, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x42,
	0x42, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x40,
	0x40, 0x40, 0x40, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x78, 0x44, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x7E, 0x40, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40,
	0x40, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x40, 0x40, 0x40,
	0x7C, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3C, 0x42, 0x42, 0x40, 0x40, 0x4E, 0x42, 0x42, 0x46, 0x3A, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x42, 0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42,
	0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x44, 0x44, 0x38, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x42, 0x44, 0x48, 0x50, 0x60, 0x60, 0x50, 0x48,
	0x44, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x40, 0x40,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x42, 0x42, 0x66, 0x66, 0x5A, 0x5A, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x42, 0x62, 0x62, 0x52, 0x52, 0x4A, 0x4A, 0x46,
	0x46, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x42,
	0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x7C, 0x42, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x5A,
	0x66, 0x3C, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x42, 0x42, 0x42,
	0x7C, 0x48, 0x44, 0x44, 0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3C, 0x42, 0x42, 0x40, 0x30, 0x0C, 0x02, 0x42, 0x42, 0x3C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x7F, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x42, 0x42, 0x42,
	0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x41, 0x41, 0x41, 0x22, 0x22, 0x22, 0x14, 0x14, 0x08, 0x08, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x42, 0x42, 0x42, 0x42, 0x5A, 0x5A, 0x66, 0x66,
	0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x42, 0x24, 0x24,
	0x18, 0x18, 0x24, 0x24, 0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x41, 0x41, 0x22, 0x22, 0x14, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x7E, 0x02, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40,
	0x40, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x40, 0x40, 0x20, 0x10, 0x10, 0x08, 0x08, 0x04, 0x02, 0x02, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x70, 0x00, 0x00, 0x00, 0x18, 0x24, 0x42, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x00,
	0x00, 0x20, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x42,
	0x02, 0x3E, 0x42, 0x42, 0x46, 0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40,
	0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x42, 0x62, 0x5C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x40, 0x40, 0x40, 0x40,
	0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x02, 0x3A, 0x46,
	0x42, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x3C, 0x42, 0x42, 0x7E, 0x40, 0x40, 0x42, 0x3C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0C, 0x10, 0x10, 0x10, 0x7C, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x3A, 0x44,
	0x44, 0x44, 0x38, 0x20, 0x3C, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00, 0x40,
	0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x08, 0x08, 0x00, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x00, 0x0C, 0x04,
	0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x48, 0x30, 0x00, 0x00, 0x00, 0x00,
	0x40, 0x40, 0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44, 0x42, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x49,
	0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x42,
	0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5C, 0x62,
	0x42, 0x42, 0x42, 0x42, 0x62, 0x5C, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x3A, 0x46, 0x42, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x02, 0x02,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5C, 0x62, 0x42, 0x40, 0x40, 0x40,
	0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x42,
	0x40, 0x30, 0x0C, 0x02, 0x42, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x10, 0x10, 0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
	0x46, 0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x42,
	0x42, 0x24, 0x24, 0x24, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x41, 0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x42, 0x24, 0x18, 0x18, 0x24,
	0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x42,
	0x42, 0x42, 0x42, 0x26, 0x1A, 0x02, 0x02, 0x3C, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x7E, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7E, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0C, 0x10, 0x10, 0x08, 0x08, 0x10, 0x10, 0x08, 0x08,
	0x10, 0x10, 0x0C, 0x00, 0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x30,
	0x08, 0x08, 0x10, 0x10, 0x08, 0x08, 0x10, 0x10, 0x08, 0x08, 0x30, 0x00,
	0x00, 0x00, 0x00, 0x31, 0x49, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

/*
 * DAT_00001B04
 * REV: Check if CTW was found and started?
 */
int ctw_was_found;

/*
 * DAT_00001B08
 * REV: Check if sceKernelLibrary is present?
 */
int sceKernelLib_started;

/*
 * DAT_00001B0C
 * REV: Timer that increases when player presses combination to open menu (L + UP), it must increase
 *       to > 100 to open menu.
 */
int L_up_time_pressed;

/*
 * DAT_00001B10
 * REV: Is menu currently displaying?
 */
int menu_displaying;

/*
 * DAT_00001B14
 * REV: For checking if player has just pressed a button
 */
u32 old_buttons;

/*
 * DAT_00001b18
 * REV: Previous Handler (to run)
 */
static STMOD_HANDLER previous;

/*
 * DAT_00001B1C
 * REV: String to store Vehicle Types (from .ini file)
 */
char* vehicle_types[106];

/*
 * DAT_00001CC4
 * REV: Unknown
 */
int PTR_00001cc4;

/*
 * DAT_00001CC8
 * REV: Check PSP buttons
 */
SceCtrlData pad;

/*
 * DAT_00001CD8
 * REV: Entry Num
 */
char entry_num[4];

/*
 * DAT_00001DDC
 * REV: String to store the game title id (to check if it's european or american)
 */
char ctw_titleid[12];

/*
 * DAT_00001DE8
 * REV: String to store Vehicle Names (from .ini file)
 */
char* vehicle_names[106];

/*
 * DAT_00001F90
 * REV: Unknown? (It's used for copying stuff to mem, but what then?)
 */
int array_data[0x80];

/*
 * FUN_00000208
 * REV: Plugin's main thread, where almost everything happens :D
 *       (Also put here for module_start)
 */
int main_thread(SceSize args, void *argp);

/*
 * FUN_00000000
 * REV: Runs when plugin needs to exit, referenced in exports.exp
 */
int module_stop(SceSize args, void *argp)
{
  return 0;
}

/*
 * FUN_00000008
 * REV: Start of the plugin, referenced in exports.exp
 */
int module_start(SceSize args, void *argp)
{
  SceUID thid;

  thid = sceKernelCreateThread("ctwcheatdevice",main_thread,0x22,0x4000,0,NULL);

  if (thid >= 0) {
    sceKernelStartThread(thid,args,argp);
  }

  return 0;
}

/*
 * FUN_00000070
 * REV: Module handler
 */
int module_start_handler(SceModule2 *module)
{
  int ret;
  int strcmp_ret;

  if (previous == NULL) {
    ret = 0;
  }
  else {
    ret = (*previous)(module);
  }
  if (sceKernelLib_started != 0) {
    sceKernelLib_started = 0;
    strcmp_ret = strcmp(module->modname,"CTW");
    if (strcmp_ret == 0) {
      ctw_was_found = 1;
    }
    else {
      ctw_was_found = 0xffffffff;
    }
  }
  strcmp_ret = strcmp(module->modname,"sceKernelLibrary");
  if (strcmp_ret == 0) {
    sceKernelLib_started = 1;
  }
  return ret;
}

/*
 * FUN_00000128
 * REV: Resumes game's threads after suspending them.
 *       Doesn't work on PPSSPP (addresses for thread ids are different there).
 */
void resume_ctw_threads(void)
{
  sceKernelResumeThread(*(SceUID*)(0x09fe7000));
  sceKernelResumeThread(*(SceUID*)(0x09fd5c00));
  sceKernelResumeThread(*(SceUID*)(0x09fd6400));
  sceKernelResumeThread(*(SceUID*)(0x09fd6800));
  sceKernelResumeThread(*(SceUID*)(0x09fef000));
  sceKernelResumeThread(*(SceUID*)(0x09ff0000));
  return;
}

/*
 * FUN_00000198
 * REV: Suspends game's threads to allow for drawing on to screen (and pausing the game)
 *       Doesn't work on PPSSPP (addresses for thread ids are different there).
 */
void suspend_ctw_threads(void)
{
  sceKernelSuspendThread(*(SceUID*)(0x09ff0000));
  sceKernelSuspendThread(*(SceUID*)(0x09fef000));
  sceKernelSuspendThread(*(SceUID*)(0x09fd6800));
  sceKernelSuspendThread(*(SceUID*)(0x09fd6400));
  sceKernelSuspendThread(*(SceUID*)(0x09fd5c00));
  sceKernelSuspendThread(*(SceUID*)(0x09fe7000));
  return;
}

/*
 * FUN_00000208
 * REV: Plugin's main thread, where almost everything happens :D
 */
int main_thread(SceSize args, void *argp)
{
  void *gameinfo;
  int ctw_eu_ver;
  SceUID fd;
  SceSize filesize;
  SceUID blockid;
  void *blockaddr;
  int strcmp_ini;
  char *pcVar1;
  int ctw_us_ver;
  int uVar2;
  int uVar3;
  int uVar4;
  int *puVar5;
  int *array_ptr;
  int filebyte_counter;
  char *vehicle_name;
  char *vehicle_type;
  int counter_types;
  int counter_names;
  int offset;

  previous = sctrlHENSetStartModuleHandler((STMOD_HANDLER)module_start_handler);

  while (ctw_was_found == 0) {
    sceKernelDelayThread(0);
  }

  /* REV: What struct does this function even return? Title ID surely must be at offset 0x44... */
  gameinfo = sceKernelGetGameInfo();
  strcpy(ctw_titleid, (char*)(gameinfo + 0x44));

  /* REV: Clean Data Array */
  memset(array_data, 0, 0x80);
  array_ptr = &array_data[0];

  /* REV: Did qwikrazor87 write instructions manually? Or is this ghidra's fault? */
  array_data[6]     = 0x105f0007;
  array_data[2]     = 0x105f000b;
  array_data[0xc]   = 0x10000003;
  array_data[0xe]   = 0x3c020880;
  array_data[0x11]  = 0xa08821;
  array_data[10]    = 0x105f0003;
  array_data[0xf]   = 0x8c450f00;

  /* 
   * REV: Check Game Version (EU or US)
   * Also there's references to unknown addresses in ram...
   * What do these do?
   */
  ctw_eu_ver = strcmp(ctw_titleid, "ULES01347");

  if (ctw_eu_ver == 0) {
    *(int *)(0x08a43504) = 0xa200400;
    array_data[5]     = 0x34428c14;
    array_data[1]     = 0x3442dbd8;
    array_data[9]     = 0x34429c44;
    array_data[0x10]  = 0xa290d43;
    PTR_00001cc4      = *(int*)(0x08a43504);
  }
  else {
    ctw_us_ver = strcmp(ctw_titleid, "ULUS10490");

    if (ctw_us_ver != 0) {
      return 0;
    }

    *(int *)(0x08a43450) = 0xa200400;
    array_data[5]     = 0x34428b14;
    array_data[1]     = 0x3442db24;
    array_data[9]     = 0x34429b44;
    array_data[0x10]  = 0xa290d16;
    PTR_00001cc4 =     *(int *)(0x08a43450);
  }
  array_data[8] = 0x3c0208b8;
  array_data[4] = 0x3c0208b8;
  array_data[0] = 0x3c0208a1;
  offset = 0;

  /* 
   * REV: Copy array_data to 0x08801000, it must patch some function? 
   * because the user_main thread is not created anymore (preventing it from crashing)...
   */
  puVar5 = (int *)(0x08801000);
  do {
    uVar2     = array_ptr[1];
    uVar3     = array_ptr[2];
    uVar4     = array_ptr[3];
    *puVar5   = *array_ptr;
    puVar5[1] = uVar2;
    puVar5[2] = uVar3;
    array_ptr = array_ptr + 4;
    puVar5[3] = uVar4;
    puVar5    = puVar5 + 4;
  } while (array_ptr != (array_data + 0x80));

  /* REV: Clear Cache so that change above actually works...*/
  ClearCaches();

  /* REV: Read ctwvehicles.txt */
  fd = sceIoOpen("ms0:/seplugins/ctw/ctwvehicles.txt", PSP_O_RDONLY, 511);

  /* REV: Get File Size to alloc partition */
  filesize = sceIoLseek32(fd,0,SEEK_END);
  sceIoLseek(fd,0,SEEK_SET);

  blockid = sceKernelAllocPartitionMemory(PSP_MEMORY_PARTITION_KERNEL,"block",PSP_SMEM_Low,filesize,NULL);

  blockaddr = sceKernelGetBlockHeadAddr(blockid);
  sceIoRead(fd,blockaddr,filesize);
  sceIoClose(fd);

  *(char *)(blockaddr + filesize) = '\n';

  entry_num[0] = '1';

  /* REV: Read Data From Partition */
  if (0 < (int)filesize) {
    filebyte_counter = 0;
    counter_names = 0;
    counter_types = 0;
    do {
      while( 1 ) {
        filebyte_counter = filebyte_counter + 1;
        strcmp_ini = strncmp(blockaddr,"#name",5);
        if (strcmp_ini != 0) break;
        vehicle_name = (char *)(blockaddr + 5);
        pcVar1 = trim_whitespace(vehicle_name);
        vehicle_names[counter_names] = pcVar1;
        counter_names = counter_names + 1;
        strcmp_ini = strncmp(vehicle_name,"#type",5);
        if (strcmp_ini != 0) goto LAB_00000494;
        vehicle_type = (char *)(blockaddr + 10);
LAB_000004f0:
        pcVar1 = trim_whitespace(vehicle_type);
        vehicle_types[counter_types] = pcVar1;
        counter_types = counter_types + 1;
        blockaddr = vehicle_type + 1;
        if ((int)filesize <= filebyte_counter) goto LAB_00000514;
      }
      strcmp_ini = strncmp(blockaddr,"#type",5);
      vehicle_name = (char *)blockaddr;
      if (strcmp_ini == 0) {
        vehicle_type = (char *)(blockaddr + 5);
        goto LAB_000004f0;
      }
LAB_00000494:
      blockaddr = vehicle_name + 1;
    } while (filebyte_counter < (int)filesize);
  }
LAB_00000514:
  if (ctw_was_found < 1) {
    return 0;
  }

  /* Main Loop */
  counter_types = 1;
  do {
    sceCtrlReadBufferPositive(&pad,1);
    if (menu_displaying == 0) {
      if ((pad.Buttons & (PSP_CTRL_LTRIGGER | PSP_CTRL_UP)) == (PSP_CTRL_LTRIGGER | PSP_CTRL_UP)) {
        L_up_time_pressed++;
      }
      else {
        L_up_time_pressed = 0;
      }
    }
    else {
      L_up_time_pressed = 0;
      do {
        sceCtrlReadBufferPositive(&pad,1);
        psp_printf(0,0,"Grand Theft Auto: Chinatown Wars\nCheat Device Menu",0xff0000);

        psp_printf(0,48,"Name:",0xffffff);
        psp_printf(0,64,vehicle_names[counter_types],0xff00);

        psp_printf(0,80,"Vehicle type:",0xffffff);
        psp_printf(0,96,vehicle_types[counter_types],0xff00);

        psp_printf(0,112,"Entry:",0xffffff);
        psp_printf(0,128,entry_num,0xff00);

        psp_printf(407,255,ctw_titleid,0xffffff);
        psp_printf(0,144,"Cheat:",0xffffff);

        pcVar1 = cheat_state ? "Enabled" : "Disabled";
        psp_printf(0,160,pcVar1,0xff00);

        psp_printf(0,207,"Up/Down: scroll by one",0x808080);
        psp_printf(0,223,"Left/Right: scroll by ten",0x808080);
        psp_printf(0,239,"Start: enable/disable cheat",0x808080);
        psp_printf(0,255,"Select: resume game",0x808080);

        sceKernelDelayThread(100);

        if ((pad.Buttons & PSP_CTRL_SELECT) == 0) {
          if (pad.Buttons != old_buttons) {
            if ((pad.Buttons & PSP_CTRL_DOWN) == 0) {
              if ((pad.Buttons & PSP_CTRL_UP) == 0) {
                if ((pad.Buttons & PSP_CTRL_LEFT) != 0) {
                  ClearFrameBuf(0);
                  counter_types -= 10;
                  if (counter_types < 0) goto LAB_00000848;
                  goto LAB_000007e8;
                }
                if ((pad.Buttons & PSP_CTRL_RIGHT) == 0) {
                  if ((pad.Buttons & PSP_CTRL_START) != 0) {
                    ClearFrameBuf(0);

                    /* REV: What does this even do? */
                    if (cheat_state == 1) {
                      cheat_state = 0;
                      **(int **)(&PTR_00001cc4 + offset) = 0xa08825;
                    }
                    else {
                      cheat_state = 1;
                      **(int **)(&PTR_00001cc4 + offset) = 0xa200400;
                    }
                    ClearCaches();
                  }
                  goto LAB_000005e4;
                }
                ClearFrameBuf(0);
                counter_types += 10;
              }
              else {
                ClearFrameBuf(0);
                counter_types++;
              }
              if (counter_types < 106) {
LAB_000007e8:
                counter_names = counter_types + 1;
              }
              else {
                counter_types = 0;
                counter_names = 1;
              }
            }
            else {
              ClearFrameBuf(0);
              counter_types--;
              if (counter_types >= 0) goto LAB_000007e8;
LAB_00000848:
              counter_types = 105;
              counter_names = 106;
            }
            old_buttons = pad.Buttons;
            *(int *)(0x08800f00) = counter_types;
            ClearCaches();
            sprintf(entry_num,"%d",counter_names);
          }
        }
        else {
          /* REV: Close Menu */
          do {
            sceCtrlReadBufferPositive(&pad,1);
          } while ((pad.Buttons & PSP_CTRL_SELECT) != 0);
          menu_displaying = 0;
          resume_ctw_threads();
        }
LAB_000005e4:
        old_buttons = pad.Buttons;
      } while (menu_displaying != 0);
    }
    if (L_up_time_pressed < 101) {
      sceKernelDelayThread(100);
      if (ctw_was_found < 1) {
        return 0;
      }
    }
    /* REV: Open Menu */
    else {
      suspend_ctw_threads();
      sceKernelDelayThread(250000);
      sceDisplaySetFrameBuf((void *)(VRAM),0x200,PSP_DISPLAY_PIXEL_FORMAT_8888,PSP_DISPLAY_SETBUF_NEXTFRAME);
      menu_displaying = 1;
      ClearFrameBuf(0);
      do {
        sceCtrlReadBufferPositive(&pad,1);
      } while ((pad.Buttons & PSP_CTRL_UP) != 0);
      sceKernelDelayThread(100);
      if (ctw_was_found < 1) {
        return 0;
      }
    }
  } while( 1 );
}

/*
 * UndefinedFunction_00000A5C
 * REV: UNUSED FUNCTION - Used by qwikrazor87 to debug his plugin
 */
void __attribute__((used)) UNUSED_00000A5C_WriteLog(char *string)
{
  SceUID fd = sceIoOpen("ms0:/logger.txt",PSP_O_WRONLY | PSP_O_CREAT | PSP_O_APPEND,511);

  sceIoWrite(fd,string,strlen(string));
  sceIoClose(fd);
  return;
}

/*
 * UndefinedFunction_00000AB8
 * REV: UNUSED FUNCTION - Unknown
 */
int __attribute__((used)) UNUSED_00000AB8_Unknown(int param_1)
{
  if (0x1BFFFFF < param_1 + 0xF7C00000U) {
    return param_1 + 0x78000000U < 0x2000000;
  }
  return 1;
}